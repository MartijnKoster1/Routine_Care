---
title: "Assignment"
author:  
- Martijn Koster, 6234119
- Jurrian van de Kraats, student nr
- Tim Poorthuis, student nr

date: "2023-02-15"

output:
  bookdown::pdf_book:
    extra_dependencies: "subfig"
    toc: false 
    number_sections: false
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, comment = NA, warning = FALSE,
                      error=FALSE, results='hide',fig.keep='all')
```

# Introduction

```{r, include=FALSE}
library(rms)
library(tidyverse)
library(kableExtra)
library(psych)
```


```{r, include = FALSE}
data <- read.table("data.txt", sep="\t")
attach(data)
```





Write here a short motivation with a RQ 

- well articulated RQ

__The aim of the study is to assess whether annual influenza vaccination reduces the risk of hospitalization among elderly (i.e., people aged >=65 years).__ 



# Methods

```{r dag, fig.cap = 'DAG model with Vaccine as exposure and hospitalization as outcome'}
library(ggdag)
library(dagitty) 
library(tidyverse)

dag1 <- dagify(
  hlsU ~ sex + age + oU, # + other unobseverd variables that accumulate in this one (like smoking)
  cntct ~ hlsU, #healthy life style is unobserved, contact is a proxy
  vacc ~ cntct + age, # if you have not seen your GP in the last 12 months, you are not vaccinated
  pulm ~ hlsU, # rokerslong door niet gezonde levenstijl
  DM ~ age + cntct + hlsU, # diabetes door niet gezonden levenstijl, geen contact met de docter, en leeftijd
  cvd ~ age + cntct + pulm + DM + hlsU, # hart en vaatziektes door leeftijd, geen contact met docter, rokerslong, diabetes en niet gezonde levenstijl
  hosp ~ cvd + pulm + DM + cntct + vacc + sex, # hosp door alle enge ziektes en geen griepvaccine. 
  exposure = "vacc", # The treatment
  outcome = "hosp" # The effect of treatment
  # optional: give co-ordinates of the variables in the plot
) 
ggdag_status(dag1) + theme_dag()
```

## Selection of confounders

Based on the Directed Acyclical Graph (DAG) model in Figure @ref(fig:dag) confounders were selected to adjust the statistical model. 

## Statistical Methods

### Baseline Characteristics 
Baseline characteristics are important, because they provide essential information on the participant and help to ensure that the study is conducted in a fair and unbiased manner. The baseline characteristics of the study were summarised. The categorical variables were summarised as frequencies and means, whereas the continuous variables as means SD. The baseline characteristics will be stratified by both the exposure as the outcome variable. 

### Propensity Score Model
| In order to control for confounding (observed and unobserved), a propensity score score was estimated by fitting a logistic regression. The variables used to calculate the propensity score are derived from the aforementioned DAG, namely: age, sex, cardiovascular disease, pulmonary disease, diabetis mellitus, and GP contact in 12 months prior to start of study. For the variables age and contact a spline is used, because it has shown favorable performance compared to other propensity score methods (Tian, Baro & Zhang, 2019). 
| 
We will develop a propensity score model and calculate Inverse probability weighting





```{r}
ps.formula <- vacc ~ rcs(age) + cvd + DM + rcs(contact) + pulm + sex

ps.fit <- lrm(ps.formula, data=data)
ps.fit$stats['C']
```

The confounders are moderately related with the exposure of interest (C=0.66)
--> Add some interpretation here.



```{r, fig.show='hide'}
data$ps.score <- predict(ps.fit,type='fitted')
hist(data$ps.score)
```

```{r ps_score, fig.cap = 'Distribution of the Propensity score for participants who received a vaccination compared with those who did not receive a vaccination' }
data %>% 
  ggplot() + 
  aes(x=ps.score, fill=as.factor(vacc)) + 
  geom_histogram(aes(y=..density..), position='identity', alpha=0.3) + 
  geom_density(aes(color=as.factor(vacc)),alpha=0.1, position='identity') +
  theme_minimal() +
  xlab("PS Score") +
  ylab("Density") +
  labs(fill = "Vaccination") + 
  scale_fill_discrete(labels = c("Unvaccinated", "Vaccinated")) +
  guides(color=FALSE) + xlim(0,1)
```

```{r}
mean(data$ps.score[vacc==0]) ; mean(data$ps.score[vacc==1])
```
We see that the mean propensity score for the ones who are vaccinated is higher (As expected)


```{r}
data$ipw <- with(data, 1 / (ifelse(data$vacc == 1, ps.score, 1-ps.score)))
```
Assignment
These are the unstabilised weights of the inverse probability score. 


We can use stabilised weights as well

What's the difference compared to unstabilized weights?
_The difference is in the numerator of the weights. Here, the results are equal, because the numerator is just a constant. However, the numerator model can include confounders too, in which case the stabilized weight yield more stable estimates._


```{r}
num <- glm(vacc ~ 1, family='binomial', data=data)$fitted.values
data$ipw.stab <- data$ipw * num  
```


```{r}
sum(data$ipw.stab)
sum(data$ipw)
nrow(data)

```

WE need to check for positivity: 

The positivity assumption means that both exposed and unexposed individuals need to be present in all sub-populations defined by the combinations of covariate values --> Westreich, D., & Cole, S. R. (2010). Invited commentary: positivity in practice. American journal of epidemiology, 171(6), 674-677. 



There is non-positivity


- Checking assumptions of method to control for confounding

- Implementation of methods to control for (observed/unobserved) confounding




# Results

## Baseline Characteristics 




```{r}
tot_vacc <- sum(vacc)
tot_novacc <- sum(vacc==0)

age_mean <- round(mean(age),2)
age_sd <- round(sd(age),2)


age_vacc_mean <- round(mean(age[vacc==1]),2)
age_novacc_mean <- round(mean(age[vacc==0]),2)
age_vacc_sd <- round(sd(age[vacc==1]),2)
age_novacc_sd <- round(sd(age[vacc==0]),2)

contact_mean <- round(mean(contact),2)
contact_vacc_mean <- round(mean(contact[vacc==1]),2)
contact_novacc_mean <- round(mean(contact[vacc==0]),2)
contact_sd <- round(sd(contact),2)
contact_vacc_sd <- round(sd(contact[vacc==1]),2)
contact_novacc_sd <- round(sd(contact[vacc==0]),2)

pulm_sum <- sum(pulm)
pulm_mean <- round(100*mean(pulm), 2)

pulm_vacc_sum <- sum(pulm[vacc==1])
pulm_vacc_mean <- round(100*mean(pulm[vacc==1]),2)
pulm_novacc_sum <- sum(pulm[vacc==0])
pulm_novacc_mean <- round(100*mean(pulm[vacc==0]),2)

sex_sum <- sum(sex) #1=female
sex_mean <- round(100*mean(sex), 2)

sex_vacc_sum <- sum(sex[vacc==1])
sex_vacc_mean <- round(100*mean(sex[vacc==1]),2)

sex_novacc_sum <- sum(sex[vacc==0])
sex_novacc_mean <- round(100*mean(sex[vacc==0]),2)

cvd_sum <- sum(cvd) #1=female
cvd_mean <- round(100*mean(cvd),2)

cvd_vacc_sum <- sum(cvd[vacc==1])
cvd_vacc_mean <- round(100*mean(cvd[vacc==1]),2)

cvd_novacc_sum <- sum(cvd[vacc==0])
cvd_novacc_mean <- round(100*mean(cvd[vacc==0]),2)

dm_sum <- sum(DM) #1=female
dm_mean <- round(100*mean(DM),2)

dm_vacc_sum <- sum(DM[vacc==1])
dm_vacc_mean <- round(100*mean(DM[vacc==1]),2)

dm_novacc_sum <- sum(DM[vacc==0])
dm_novacc_mean <- round(100*mean(DM[vacc==0]),2)
```


```{r}

age_hosp_mean <- round(mean(age[hosp==1]),2)
age_nohosp_mean <- round(mean(age[hosp==0]),2)
age_hosp_sd <- round(sd(age[hosp==1]),2)
age_nohosp_sd <- round(sd(age[hosp==0]),2)


contact_hosp_mean <- round(mean(contact[hosp==1]),2)
contact_nohosp_mean <- round(mean(contact[hosp==0]),2)

contact_hosp_sd <- round(sd(contact[hosp==1]),2)
contact_nohosp_sd <- round(sd(contact[hosp==0]),2)


pulm_hosp_sum <- sum(pulm[hosp==1])
pulm_hosp_mean <- round(100*mean(pulm[vacc==1]),2)
pulm_nohosp_sum <- sum(pulm[hosp==0])
pulm_nohosp_mean <- round(100*mean(pulm[hosp==0]),2)


sex_hosp_sum <- sum(sex[hosp==1])
sex_hosp_mean <- round(100*mean(sex[hosp==1]),2)

sex_nohosp_sum <- sum(sex[hosp==0])
sex_nohosp_mean <- round(100*mean(sex[hosp==0]),2)


cvd_hosp_sum <- sum(cvd[hosp==1])
cvd_hosp_mean <- round(100*mean(cvd[hosp==1]),2)

cvd_nohosp_sum <- sum(cvd[hosp==0])
cvd_nohosp_mean <- round(100*mean(cvd[hosp==0]),2)


dm_hosp_sum <- sum(DM[hosp==1])
dm_hosp_mean <- round(100*mean(DM[hosp==1]),2)

dm_nohosp_sum <- sum(DM[hosp==0])
dm_nohosp_mean <- round(100*mean(DM[hosp==0]),2)

vacc_hosp_sum <- sum(vacc[hosp==1])
vacc_hosp_mean <- round(100*mean(vacc[hosp==1]),2)

vacc_nohosp_sum <- sum(vacc[hosp==0])
vacc_nohosp_mean <- round(100*mean(vacc[hosp==0]),2)
```


```{r}


characteristics <- c('N', 'Age, mean (SD)', 'Contact, mean (SD)', 'Female, n (%)', 'Pulmonary disease, n (%)', 'Cardiovascular disease, n (%)', 'Diabetes mellitus, n(%)', 'Received Influenza Vaccination, n (%)')
total <- c(nrow(data), paste0(age_mean, ' (', age_sd, ')'),
           paste0(contact_mean, ' (', contact_sd, ')'),
           paste0(sex_sum, ' (', sex_mean, ')'),
           paste0(pulm_sum, ' (', pulm_mean, ')'),
           paste0(cvd_sum, ' (', cvd_mean, ')'),
           paste0(dm_sum, ' (', dm_mean, ')'),
           ""
           )

vaccinated <- c(tot_vacc, paste0(age_vacc_mean, ' (', age_vacc_sd, ')'),
           paste0(contact_vacc_mean, ' (', contact_vacc_sd, ')'),
           paste0(sex_vacc_sum, ' (', sex_vacc_mean, ')'),
           paste0(pulm_vacc_sum, ' (', pulm_vacc_mean, ')'),
           paste0(cvd_vacc_sum, ' (', cvd_vacc_mean, ')'),
           paste0(dm_vacc_sum, ' (', dm_vacc_mean, ')'), 
           ""
           )

not_vaccinated <-  c(tot_novacc, paste0(age_novacc_mean, ' (', age_novacc_sd, ')'),
           paste0(contact_novacc_mean, ' (', contact_novacc_sd, ')'),
           paste0(sex_novacc_sum, ' (', sex_novacc_mean, ')'),
           paste0(pulm_novacc_sum, ' (', pulm_novacc_mean, ')'),
           paste0(cvd_novacc_sum, ' (', cvd_novacc_mean, ')'),
           paste0(dm_novacc_sum, ' (', dm_novacc_mean, ')'),
           ""
           )


hospitalized <- c(sum(hosp), paste0(age_hosp_mean, ' (', age_hosp_sd, ')'),
           paste0(contact_hosp_mean, ' (', contact_hosp_sd, ')'),
           paste0(sex_hosp_sum, ' (', sex_hosp_mean, ')'),
           paste0(pulm_hosp_sum, ' (', pulm_hosp_mean, ')'),
           paste0(cvd_hosp_sum, ' (', cvd_hosp_mean, ')'),
           paste0(dm_hosp_sum, ' (', dm_hosp_mean, ')'), 
           paste0(vacc_hosp_sum, ' (', vacc_hosp_mean, ')')
           )

not_hospitalized <-  c(sum(hosp==0), paste0(age_nohosp_mean, ' (', age_nohosp_sd, ')'),
           paste0(contact_nohosp_mean, ' (', contact_nohosp_sd, ')'),
           paste0(sex_nohosp_sum, ' (', sex_nohosp_mean, ')'),
           paste0(pulm_nohosp_sum, ' (', pulm_nohosp_mean, ')'),
           paste0(cvd_nohosp_sum, ' (', cvd_nohosp_mean, ')'),
           paste0(dm_nohosp_sum, ' (', dm_nohosp_mean, ')'),
           paste0(vacc_nohosp_sum, ' (', vacc_nohosp_mean, ')')
           )



tab1 <- data.frame(
  variables = characteristics, 
  total = total, 
  vaccinated = vaccinated,
  not_vaccinated = not_vaccinated,
  hospitalized,
  not_hospitalized
  
)
```


```{r}

# 
# characteristics <- c('N', 'Age, mean (SD)', 'Contact, mean (SD)', 'Female, n (%)', 'Pulmonary disease, n (%)', 'Cardiovascular disease, n (%)', 'Diabetes mellitus, n(%)', 'Vaccinated, n(%)')
# total <- c(nrow(data), paste0(age_mean, ' (', age_sd, ')'),
#            paste0(contact_mean, ' (', contact_sd, ')'),
#            paste0(sex_sum, ' (', sex_mean, ')'),
#            paste0(pulm_sum, ' (', pulm_mean, ')'),
#            paste0(cvd_sum, ' (', cvd_mean, ')'),
#            paste0(dm_sum, ' (', dm_mean, ')')
#            )
# 
# vaccinated <- c(tot_vacc, paste0(age_vacc_mean, ' (', age_vacc_sd, ')'),
#            paste0(contact_vacc_mean, ' (', contact_vacc_sd, ')'),
#            paste0(sex_vacc_sum, ' (', sex_vacc_mean, ')'),
#            paste0(pulm_vacc_sum, ' (', pulm_vacc_mean, ')'),
#            paste0(cvd_vacc_sum, ' (', cvd_vacc_mean, ')'),
#            paste0(dm_vacc_sum, ' (', dm_vacc_mean, ')')
#            )
# 
# not_vaccinated <-  c(tot_novacc, paste0(age_novacc_mean, ' (', age_novacc_sd, ')'),
#            paste0(contact_novacc_mean, ' (', contact_novacc_sd, ')'),
#            paste0(sex_novacc_sum, ' (', sex_novacc_mean, ')'),
#            paste0(pulm_novacc_sum, ' (', pulm_novacc_mean, ')'),
#            paste0(cvd_novacc_sum, ' (', cvd_novacc_mean, ')'),
#            paste0(dm_novacc_sum, ' (', dm_novacc_mean, ')')
#            )
# 
# 
# tab1 <- data.frame(
#   variables = characteristics, 
#   total = total, 
#   vaccinated = vaccinated,
#   not_vaccinated = not_vaccinated
# )
```

| Table \@ref(tab:des) presents the baseline characteristics of 40,000 individuals who were included in the study. The mean age `r age_mean`  and the majority of the study population `r sex_mean`% were female. Approximately half of the respondent have Cardiovascular disease, whereas `r pulm_mean` percent have Pulmonary disease and `r dm_mean`% have Diabetes Mellitus.
|   A total of `r sum(vacc)` (`r round(100*mean(vacc),2)`%) respondents were vaccinated, whreas `r sum(vacc==0)` (`r round(100*mean(vacc==0),2)`%) were not vaccinated. People who received a vaccination had on average more often pulmonary disease (`r pulm_vacc_mean`% vs `r pulm_novacc_mean`%), cardiovascular disease (`r cvd_vacc_mean`% vs `r cvd_novacc_mean`%) and diabetes (`r dm_vacc_mean`% vs `r dm_novacc_mean`%).
|   Baseline characteristics stratified by the study outcome indicate that `r sum(hosp)` of the respondents were hospitalized as opposed to `r sum(hosp==0)` who were not. Respondents who were hospitalized were older (`r age_hosp_mean` vs `r age_nohosp_mean`), had more often contact with the GP (`r contact_hosp_mean` vs `r contact_nohosp_mean`), were on average less often a female (`r sex_hosp_mean`% vs `r sex_nohosp_mean`%), had on average more often cardiovascular disease (`r cvd_hosp_mean`% vs `r cvd_nohosp_mean`%) and on average more often Diabetes (`r dm_hosp_mean`% vs `r dm_nohosp_mean`%). 


```{r des, echo = FALSE, results='hold'}
tab1 %>%
  kbl(caption = 'Baseline Characteristics stratified by Influenza vaccination received and Hospitalisation',
      col.names = c('Characteristics', 'Total', 'Yes', 'No', 'Yes', 'No'),
      booktabs = T) %>%
  kable_classic(full_width = F, html_font = 'Cambria') %>% 
  add_header_above(c(" ", " ", "Influenza vaccination received" = 2, 'Hospitalized'=2)) %>% 
  kable_styling(latex_options = "hold_position")

```


- Reporting characteristics of study population 

- Reporting crude/adjusted effect measures 

Crude measures:

```{r}
crude.fit <- lrm(hosp ~ vacc, data=data)
log.or <- crude.fit$coef[2]
se.log.or <- sqrt(diag(vcov(crude.fit))[2])
res_crude <- round(exp(c(log.or, log.or - 1.96*se.log.or, log.or + 1.96*se.log.or)), 3)


res_crude_c <- round(crude.fit$stats['C'], 3) 
res_crude_p <- round(crude.fit$stats['P'], 3)
```

```{r}
adj1.fit <- lrm(hosp ~ vacc + ps.score, data=data)
log.or <- adj1.fit$coef[2]
se.log.or <- sqrt(diag(vcov(adj1.fit))[2])

res_ps <- round(exp(c(log.or, log.or - 1.96*se.log.or, log.or + 1.96*se.log.or)), 3)

res_ps_c <- round(adj1.fit$stats['C'], 3)
res_ps_p <- round(adj1.fit$stats['P'], 3) 
```

```{r}
adj2.fit <- lrm(hosp ~ vacc, weights = ipw.stab, data=data)
log.or <- adj2.fit$coef[2]
se.log.or <- sqrt(diag(vcov(adj2.fit))[2])
res_ipw <- round(exp(c(log.or, log.or - 1.96*se.log.or, log.or + 1.96*se.log.or)), 3) 


res_ipw_c <- round(adj2.fit$stats['C'], 3)
res_ipw_p <- round(adj2.fit$stats['P'], 3)
```

```{r}
adj3.fit <- lrm(hosp ~ vacc, weights = ipw, data=data)
log.or <- adj3.fit$coef[2]
se.log.or <- sqrt(diag(vcov(adj3.fit))[2])
res_unipw <- round(exp(c(log.or, log.or - 1.96*se.log.or, log.or + 1.96*se.log.or)), 3) 


res_unipw_c <- round(adj2.fit$stats['C'], 3)
res_unipw_p <- round(adj2.fit$stats['P'], 3)
```


```{r}
print_p_value <- function(p_value) {
  if (p_value < 0.001) {
    print('<.001')
  } else {
    print(p_value)
  }
}
```


The crude association between vaccination status and hospitalization was examined using logistic regression, and the odds ratio was found to be `r res_crude[1]` (95% CI: `r res_crude[2]`, `r res_crude[3]`), indicating a non-significant association (p = `r print_p_value(res_ipw_p)`. The C statistic,  a measure of discrimination, was `r res_crude_c`, suggesting poor predictive performance of the model. 

```{r}
make_or <- function(OR) {
  paste0(OR[1], ' (', OR[2], ' to ', OR[3],')')
}
```


```{r}
models <- c('Unadjusted', 'PS score as covariate', 'Unstabilised IPW', 'Stabilised IPW')

OR_95 <- c(make_or(res_crude), make_or(res_ps), make_or(res_unipw), make_or(res_ipw))

OR_P <- c(res_crude_p, res_ps_p, res_unipw_p, res_ipw_p)

OR_C <- c(res_crude_c, res_ps_c, res_unipw_c, res_ipw_c)

tab2 <- data.frame(models,
                      OR_95, 
                      OR_P, 
                      OR_C) 
```

```{r res, echo = FALSE, results='hold'}
tab2 %>% 
   kbl(caption = 'Different regression results bla bla bla',
      col.names = c('Model Specification', 'OR (95% CI)', 'P-Value', 'C-Statistic'),
      booktabs = T) %>%
  kable_classic(full_width = F, html_font = 'Cambria') %>%
  kable_styling(latex_options = "hold_position")
```




__Adjusted measures__ 


# Conclusion / Discussion

- Conclusions supported by data

- Other issues (both positive and negative) 


# References


Yuxi Tian, Elande Baro & Rongmei Zhang (2019) Performance evaluation of regression splines for propensity score adjustment in post-market safety analysis with multiple treatments, Journal of Biopharmaceutical Statistics, 29:5, 810-821, DOI: 10.1080/10543406.2019.1657138